<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
</head>
<style>
    html,
    body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
    }

    .la {
        width: auto;
        height: auto;
        right: 0;
        margin-right: 15px;
        font-size: large;
        display: inline;
        float: right;
        background-color: #EA4C89;
        border-radius: 8px;
        border-style: none;
        box-sizing: border-box;
        color: #FFFFFF;
        cursor: pointer;
        font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        line-height: 20px;
        list-style: none;
        margin: 0;
        outline: none;
        padding: 10px 16px;
        position: relative;
        text-align: center;
        text-decoration: none;
        transition: color 100ms;
        vertical-align: baseline;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
    }

    .la:hover {
        background-color: #F082AC;
        box-shadow: #f082acce 0 8px 15px;
        transform: translateY(-2px);
    }

    .la:active {
        box-shadow: none;
        transform: translateY(0);
    }

    .la:disabled {
        pointer-events: none;
        background-color: #f082ac48;
    }

    .row {
        margin-left: 10px;
        border: 1px solid;
        padding: 10px;
    }

    .dynamic-input {
        width: 600px;
        font-size: 14px;
    }

    .footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
    }

    .console {
        background-color: black;
        color: white;
        overflow: auto;
        width: 100%;
        height: 150px;
    }

    .label {
        background-color: #F082AC;
        margin-bottom: 0;
        height: 20px;
        vertical-align: middle;
    }

    #log-reset {
        float: right;
        right: 0;
        height: 20px;
    }
</style>

<body>
    <header>
        <div class="row" style="text-align: center;background-color: red;">
            !!! ‡∏°‡∏±‡∏ô‡∏¢‡∏±‡∏á‡∏Å‡∏≤‡∏Å‡πÜ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ Pull Request ‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö !!!
        </div>
    </header>
    <div id="app">
        <div class="main"></div>
        <div class="footer"></footer>
    </div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö WebSocket -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        function resizeInput(input) {
            const textLength = input.value.length;
            if (textLength >= 720 && textLength <= 600) {
                input.style.width = textLength * 8 + 'px';
            }
        }

        async function request(url, body = {}, method = 'GET') {
            body = (method == 'POST') ? JSON.stringify(body) : null
            console.info(`[App] Requesting from/to ${url} Method: ${method} with Body: ${body}`)
            return fetch(url, {
                method: method,
                body: body,
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
        }

        window.onload = async function () {
            console.log('Welcome To GUI')

            var config
            var app
            var DATA = {}
            var data_la

            async function fetch_data() {
                console.info('[App] Fetching Data...')
                config = await (request('/get-config').then(res => res.json()))
                app = config.app

                DATA = await (request('/temp-data').then(res => res.json()))

                data_la = DATA.la

                for (let x in data_la) {
                    ad = data_la[x]
                    if (ad.lock === true) {
                        index = app.findIndex(v => v.name === x)
                        app.forEach((_, i) => {
                            app[i].lock = true
                            app[i].rename = (i === index) ? 'Launched' : 'Fully'
                        })
                        break
                    }
                }
            }

            var main = document.querySelector('.main')
            var footer = document.querySelector('.footer')
            var UI = document.querySelector('#app')

            async function create_ui() {
                console.info('[App] Creating UI')
                let child = UI.lastElementChild
                
                app.forEach(a => {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á element div
                    let node = document.createElement('div');
                    node.className = 'row';

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° 'A1111' ‡πÄ‡∏õ‡πá‡∏ô text node ‡πÉ‡∏ô div
                    let title = document.createTextNode(a.name);
                    node.appendChild(title);

                    // // ‡πÄ‡∏û‡∏¥‡πà‡∏° input checkbox ‡πÅ‡∏•‡∏∞ label 'Installed'
                    // let installed = document.createElement('input');
                    // installed.type = 'checkbox';
                    // installed.id = 'readonly'
                    // let labelInstalled = document.createElement('label');
                    // labelInstalled.textContent = 'Installed';
                    // labelInstalled.id = a.name
                    // node.appendChild(installed);
                    // node.appendChild(labelInstalled);

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° input checkbox ‡πÅ‡∏•‡∏∞ label 'Use Google Drive'
                    let use_g_drive = document.createElement('input');
                    use_g_drive.type = 'checkbox';
                    let labelGoogleDrive = document.createElement('label');
                    labelGoogleDrive.textContent = 'Use Google Drive';
                    node.appendChild(use_g_drive);
                    node.appendChild(labelGoogleDrive);

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° button 'Launch'

                    let this_data = data_la?.[a.name]

                    let launchButton = document.createElement('button');
                    launchButton.className = 'la'
                    launchButton.textContent = a.rename ?? 'Launch'
                    launchButton.id = a.name
                    launchButton.disabled = a.lock ?? false
                    node.appendChild(launchButton);
                    main.appendChild(node)

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡πÉ‡∏ô div ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞ input text ‡πÉ‡∏ô div ‡πÉ‡∏´‡∏°‡πà
                    let commandLineDiv = document.createElement('div');
                    let commandLineText = document.createTextNode('CommandLineArgs:');
                    let inputCommandLine = document.createElement('input');
                    inputCommandLine.type = 'text';
                    inputCommandLine.className = 'dynamic-input';
                    inputCommandLine.id = a.name
                    inputCommandLine.value = a.defaultArgs
                    inputCommandLine.oninput = function () {
                        resizeInput(inputCommandLine);
                    };
                    commandLineDiv.appendChild(commandLineText);
                    commandLineDiv.appendChild(inputCommandLine);
                    node.appendChild(commandLineDiv);
                    let reset = document.createElement("button")
                    reset.style.display = 'inline'
                    reset.textContent = 'üîÉ'
                    commandLineDiv.append(reset)
                })
                //Footer
                // Get the parent element <footer>
                // Create <p> element with class "label"
                const labelParagraph = document.createElement('p');
                labelParagraph.className = 'label';
                labelParagraph.textContent = 'Console:';

                const console_reset = document.createElement("button")
                console_reset.className = 'button'
                console_reset.id = 'log-reset'
                console_reset.textContent = 'Reset'

                // Create <div> element with class "console"
                const consoleDiv = document.createElement('div');
                consoleDiv.className = 'console';

                // Create <pre> element with id "console-output"
                const preElement = document.createElement('pre');
                preElement.id = 'console-output';
                preElement.textContent = DATA.log ?? ''

                // Append the <pre> element to the <div> element
                consoleDiv.appendChild(preElement);

                // Append the <p> element and <div> element to the <footer> element
                labelParagraph.appendChild(console_reset)
                fc = [labelParagraph, consoleDiv]
                fc.forEach(e => footer.appendChild(e))

                footer.style.resize = 'vertical'
            }
            async function destroy_ui() {
                let elems = UI.children;
                [...Array(elems.length)].forEach((_,i) => {
                    let e = elems[i]
                    let child = e.lastElementChild;
                    while (child) {
                        e.removeChild(child)
                        child = e.lastElementChild
                    }
                })
            }
            async function load_ui() {
                await fetch_data()
                await destroy_ui()
                await create_ui()
            }

            await load_ui()

            document.body.addEventListener('click', async function (ev) {
                let target = ev.target
                if (target) {
                    if (target.id === 'readonly') {
                        ev.preventDefault()
                    } else if (target.className === 'la') {

                        document.querySelectorAll('.la').forEach(e => {
                            e.disabled = true
                        })

                        let elem = document.querySelectorAll(`#${target.id}`)

                        let args
                        elem.forEach(e => {
                            if (e.tagName === 'INPUT') args = e.value
                        })
                        await request('/la', {
                            'name': target.id,
                            'args': args,
                            'lock': true,
                            'rename': 'Launched'
                        }, 'POST')
                            .then(res => res.text())
                            .then(text => console.log(text))
                        await fetch_data()
                        await load_ui()
                    } else if (target.id === 'log-reset') {
                        let text = await (request('/temp-data', {
                            'name': 'reset-log'
                        }, 'POST')
                            .then(res => res.text()))
                        console.log(text)
                        await load_ui()
                    }
                }
            })
            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö WebSocket ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå Flask
            const socket = io.connect(window.location.host);

            // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• output ‡∏à‡∏≤‡∏Å WebSocket ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô console
            socket.on('output', function (data) {
                const consoleOutput = document.getElementById('console-output');
                consoleOutput.textContent += data.body + '\n';
            });
        }
    </script>
</body>

</html>