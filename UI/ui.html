<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
</head>
<style>
    html {
        padding-top: 10px;
    }

    .la {
        width: auto;
        height: auto;
        position: fixed;
        right: 0;
        margin-right: 15px;
        font-size: large;
        display: inline-flex;
        justify-content: center;
        align-items: center;
    }

    .row {
        margin-left: 10px;
        border: 1px solid;
        padding: 10px;
    }

    .dynamic-input {
        width: 600px;
        font-size: 14px;
    }
</style>

<body>
    <header>
        <div class="row" style="text-align: center;background-color: red;">
            !!! มันยังกากๆอยู่นะครับใครช่วยได้ Pull Request มาเลยครับ !!!
        </div>
    </header>
    <div class="main"></div>
    <script>
        function resizeInput(input) {
            const textLength = input.value.length;
            if (textLength >= 720 && textLength <= 600) {
                input.style.width = textLength * 8 + 'px';
            }
        }
        /**@type {{name:string,defaultArgs:string}[]}*/


        window.onload = async function () {
            console.log('Welcome To GUI')

            var config
            var app
            var data_la

            async function fetch_data() {
                config = await (fetch('/get-config', {
                    method: 'GET',
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                }).then(res => res.json()))
                app = config.app

                data = await (fetch('/temp-data', {
                    method: 'GET',
                    headers: {
                        "Content-type": "application/json; charset=UTF-8"
                    }
                }).then(res => res.json()))

                data_la = data.la

                for (let x in data_la) {
                    ad = data_la[x]
                    if (ad.lock === true) {
                        index = app.findIndex(v => v.name === x)
                        app.forEach((_, i) => {
                            app[i].lock = true
                            app[i].rename = (i === index) ? 'Launched' : 'Fully'
                        })
                        break
                    }
                }
            }

            await fetch_data()

            var main = document.querySelector('.main')

            async function create_ui(main) {
                app.forEach(a => {
                    // สร้าง element div
                    let node = document.createElement('div');
                    node.className = 'row';

                    // เพิ่มข้อความ 'A1111' เป็น text node ใน div
                    let title = document.createTextNode(a.name);
                    node.appendChild(title);

                    // เพิ่ม input checkbox และ label 'Installed'
                    let installed = document.createElement('input');
                    installed.type = 'checkbox';
                    installed.id = 'readonly'
                    let labelInstalled = document.createElement('label');
                    labelInstalled.textContent = 'Installed';
                    labelInstalled.id = a.name
                    node.appendChild(installed);
                    node.appendChild(labelInstalled);

                    // เพิ่ม input checkbox และ label 'Use Google Drive'
                    let use_g_drive = document.createElement('input');
                    use_g_drive.type = 'checkbox';
                    let labelGoogleDrive = document.createElement('label');
                    labelGoogleDrive.textContent = 'Use Google Drive';
                    node.appendChild(use_g_drive);
                    node.appendChild(labelGoogleDrive);

                    // สร้าง div ใน div และเพิ่มข้อความและ input text ใน div ใหม่
                    let commandLineDiv = document.createElement('div');
                    commandLineDiv.style.display = 'inline-block';
                    let commandLineText = document.createTextNode(' | CommandLineArgs:');
                    let inputCommandLine = document.createElement('input');
                    inputCommandLine.type = 'text';
                    inputCommandLine.className = 'dynamic-input';
                    inputCommandLine.id = a.name
                    inputCommandLine.value = a.defaultArgs
                    inputCommandLine.oninput = function () {
                        resizeInput(inputCommandLine);
                    };
                    commandLineDiv.appendChild(commandLineText);
                    commandLineDiv.appendChild(inputCommandLine);
                    node.appendChild(commandLineDiv);

                    // เพิ่ม button 'Launch'

                    let this_data = data_la?.[a.name]

                    let launchButton = document.createElement('button');
                    launchButton.className = 'la';
                    launchButton.textContent = a.rename ?? 'Launch'
                    launchButton.id = a.name
                    launchButton.disabled = a.lock ?? false
                    node.appendChild(launchButton);
                    main.appendChild(node)

                })
            }

            create_ui(main)

            document.body.addEventListener('click', async function (ev) {
                let target = ev.target
                if (target) {
                    if (target.id === 'readonly') {
                        ev.preventDefault()
                    } else if (target.className === 'la') {
                        target.disabled = true
                        let elem = document.querySelectorAll(`#${target.id}`)
                        let args
                        elem.forEach(e => {
                            if (e.tagName === 'INPUT') args = e.value
                        })
                        fetch(`/la`, {
                            method: "POST",
                            body: JSON.stringify({
                                name: target.id,
                                args: args
                            }),
                            headers: {
                                "Content-type": "application/json; charset=UTF-8"
                            }
                        })
                            .then(res => res.text())
                            .then(text => console.log(text))
                        fetch(`/temp-data`, {
                            method: "POST",
                            body: JSON.stringify({
                                name: target.id,
                                args: args,
                                rename: 'Launched',
                                lock: true
                            }),
                            headers: {
                                "Content-type": "application/json; charset=UTF-8"
                            }
                        })
                            .then(res => res.text())
                            .then(text => console.log(text))
                        await fetch_data()
                        let main = document.querySelector('.main')
                        let child = main.lastElementChild
                        while (child) {
                            main.removeChild(child);
                            child = main.lastElementChild;
                        }
                        create_ui(main)
                    }
                }
            })
        }
    </script>
</body>

</html>